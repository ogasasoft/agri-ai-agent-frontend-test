# テストエラー確認チェックリスト

テスト実行でエラーが発生した場合、**実装を修正する前に**必ずこのチェックリストを確認してください。

## 🔍 **Phase 1: エラー状況の把握**

### 1.1 エラーの種類を特定
- [ ] **コンパイルエラー**: TypeScriptの型エラー、import/export エラー
- [ ] **ランタイムエラー**: 500エラー、予期しない例外
- [ ] **テスト失敗**: 期待値と実際値の不一致
- [ ] **タイムアウトエラー**: 非同期処理の完了待ち
- [ ] **モジュール解決エラー**: Jest設定やパス問題

### 1.2 影響範囲の確認  
- [ ] **単一テスト**: 1つのテストケースのみ失敗
- [ ] **単一ファイル**: 1つのテストファイル内の複数テスト失敗
- [ ] **機能全体**: 特定機能（認証、注文管理など）の全テスト失敗
- [ ] **システム全体**: 全テストファイルで同様のエラー発生

## 🧪 **Phase 2: テスト設計の妥当性確認**

### 2.1 テスト仕様 vs 実装仕様の確認
- [ ] **エラーメッセージ**: テストで期待するメッセージが実装と一致するか
  ```bash
  # 期待: 'ユーザー名またはパスワードが正しくありません。'
  # 実際: 'ユーザー名またはパスワードは正しくありません。'
  ```
- [ ] **HTTPステータスコード**: 実装が返すステータスコードが期待値と一致するか
- [ ] **レスポンス構造**: 実装のJSONレスポンス形式がテストの期待と一致するか
- [ ] **認証方式**: 実装で使用される認証方法（session token, CSRF等）がテストと一致するか

### 2.2 API仕様の変更確認
- [ ] **エンドポイントパス**: URLパスが変更されていないか
- [ ] **HTTPメソッド**: GET/POST/PUT/DELETE が期待通りか  
- [ ] **リクエストパラメータ**: 必須/任意パラメータの仕様変更
- [ ] **認証要件**: CSRF保護の有無、session token の扱い

## 🔧 **Phase 3: モック設定の確認**

### 3.1 データベースモック
- [ ] **MockDbClientの初期化**: `resetTestDatabase()` が正しく実行されているか
- [ ] **テストデータ**: `createMockUser`, `createMockOrder` 等のファクトリ関数の戻り値構造
- [ ] **クエリモック**: `mockClient.query` の戻り値が期待される形式か
- [ ] **トランザクション**: BEGIN/COMMIT/ROLLBACKの処理が適切にモックされているか

### 3.2 外部API モック
- [ ] **OpenAI API**: `global.fetch` のモック設定が正しいか
- [ ] **認証ライブラリ**: `validateSession`, `bcrypt` 等のライブラリモック
- [ ] **環境変数**: `process.env` の値がテスト用に適切に設定されているか

### 3.3 ファイル・フォーム処理モック  
- [ ] **FormData**: ファイルアップロードのモック設定
- [ ] **Request オブジェクト**: Next.js Request のモック構造
- [ ] **ヘッダー情報**: session token, CSRF token のヘッダー設定

## 📊 **Phase 4: 実装の動作確認**

### 4.1 実装ファイルの存在確認
- [ ] **APIルートファイル**: `src/app/api/{endpoint}/route.ts` が存在するか
- [ ] **ライブラリファイル**: `src/lib/auth.ts`, `src/lib/admin-auth.ts` 等が存在するか
- [ ] **型定義ファイル**: 必要な型定義が存在し、exportされているか

### 4.2 実装ロジックの基本動作
- [ ] **戻り値の構造**: 実装がテストで期待するJSON構造を返すか
- [ ] **エラーハンドリング**: try-catch でのエラー処理が適切か
- [ ] **非同期処理**: async/await の使用が適切か
- [ ] **データベース接続**: 実装でのDB接続処理が正しいか

## ⚙️ **Phase 5: 環境・設定の確認**

### 5.1 Jest設定
- [ ] **jest.config.js**: moduleNameMapper の設定が正しいか
- [ ] **testEnvironment**: 'node' または 'jsdom' が適切に設定されているか
- [ ] **setupFilesAfterEnv**: jest.setup.js の設定が有効か
- [ ] **moduleNameMapping**: '@/' パスエイリアスが正しく解決されるか

### 5.2 TypeScript設定
- [ ] **tsconfig.json**: paths の設定がJest設定と一致するか
- [ ] **型定義**: @types パッケージが適切にインストールされているか
- [ ] **import/export**: ES module と CommonJS の混在問題がないか

### 5.3 依存関係
- [ ] **package.json**: 必要な依存関係がすべてインストールされているか
- [ ] **バージョン競合**: Next.js, React, Jest のバージョン競合がないか
- [ ] **node_modules**: `npm install` が正しく実行されているか

## 🐛 **Phase 6: デバッグ手法**

### 6.1 段階的テスト実行
```bash
# 単一テストケース実行
npm test -- --testNamePattern="specific test name"

# 詳細ログ出力
npm test -- --verbose

# console.log の出力確認  
npm test -- --silent=false
```

### 6.2 実装の直接テスト
```bash
# 開発サーバー起動での手動テスト
npm run dev
curl -X POST http://localhost:3000/api/auth/login -H "Content-Type: application/json" -d '{"username":"admin","password":"admin123"}'
```

### 6.3 モックデータの確認
```typescript
// テストファイルでのデバッグ用ログ
console.log('Mock user:', mockUser);
console.log('Mock response:', await response.json());
console.log('Database mock calls:', mockClient.query.mock.calls);
```

## 📋 **Phase 7: エラーパターン別対処法**

### 7.1 500エラー（現在の問題）
**確認順序**:
1. 実装ファイル（`src/app/api/auth/login/route.ts`）が存在するか
2. 実装の基本的なJSONレスポンス構造
3. データベースモックの設定（特に `bcrypt.compare` のモック）
4. 非同期処理のエラーハンドリング
5. 環境変数の設定状況

### 7.2 認証関連エラー
**確認順序**:
1. セッション管理ライブラリ（`validateSession`）のモック
2. CSRF トークンの処理方法
3. bcrypt ライブラリのモック設定
4. データベースのユーザーデータ構造

### 7.3 データベース関連エラー
**確認順序**:
1. `MockDbClient` の実装確認
2. SQL クエリの構造とパラメータ
3. トランザクション処理のモック
4. データ型の整合性（string vs number）

## ✅ **Phase 8: 修正方針の決定**

上記チェックリストを完了後、以下を判断：

- [ ] **テスト修正が必要**: 仕様理解の誤り、モック設定の問題
- [ ] **実装修正が必要**: 実際のバグ、仕様との不整合  
- [ ] **両方修正が必要**: テストと実装の両方に問題がある
- [ ] **環境修正が必要**: Jest設定、依存関係の問題

## 🚨 **重要な注意事項**

1. **実装を修正する前に必ずこのチェックリストを完了すること**
2. **修正は1つずつ行い、その都度テストを実行して影響を確認すること**  
3. **大幅な仕様変更が必要な場合は、TDD の原則に従ってテストファーストで行うこと**
4. **既存の動作している機能に影響を与えないよう注意深く確認すること**

---

**このチェックリストを使用することで、問題の根本原因を特定し、適切な修正方針を決定できます。**